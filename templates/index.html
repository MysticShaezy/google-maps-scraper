<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Maps Scraper</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 40px 0; color: white; }
        header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .main-grid { display: grid; grid-template-columns: 380px 1fr; gap: 20px; margin-top: 20px; }
        .card { background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); overflow: hidden; }
        .card-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; font-size: 1.1rem; font-weight: 600; }
        .card-body { padding: 24px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; color: #555; font-size: 0.9rem; }
        input, select { width: 100%; padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; }
        input:focus, select:focus { outline: none; border-color: #667eea; }
        .btn { width: 100%; padding: 14px 24px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        .tabs { display: flex; gap: 4px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; }
        .tab { padding: 10px 20px; background: none; border: none; cursor: pointer; font-weight: 500; color: #666; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tab.active { color: #667eea; border-bottom-color: #667eea; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .autocomplete-container { position: relative; }
        .autocomplete-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #dadce0; border-top: none; border-radius: 0 0 8px 8px; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(60,64,67,0.15); display: none; }
        .autocomplete-dropdown.active { display: block; }
        .autocomplete-item { padding: 10px 16px; cursor: pointer; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #f1f3f4; }
        .autocomplete-item:hover, .autocomplete-item.selected { background: #f1f3f4; }
        .autocomplete-item .main-text { font-weight: 400; color: #202124; font-size: 0.95rem; }
        .autocomplete-item .secondary-text { font-size: 0.8rem; color: #5f6368; margin-top: 2px; }
        .selected-location { margin-top: 12px; padding: 12px; background: #e8f5e9; border-left: 4px solid #34a853; border-radius: 4px; display: none; }
        .selected-location.active { display: block; }
        .radius-control { margin-top: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px; }
        .radius-control input[type=range] { width: 100%; margin: 8px 0; }
        .radius-value { font-weight: 600; color: #667eea; }
        .smart-mode { margin-top: 12px; padding: 16px; background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border: 2px solid #667eea; border-radius: 8px; }
        .smart-mode label { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .smart-mode input[type=checkbox] { width: 20px; height: 20px; }
        .smart-mode .smart-description { font-size: 0.85rem; color: #666; margin-top: 8px; margin-left: 30px; }
        .progress-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0; }
        .progress-bar-container { background: #e0e0e0; border-radius: 10px; height: 20px; overflow: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(2,1fr); gap: 12px; margin-top: 16px; }
        .stat-box { background: #f8f9fa; padding: 12px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: #667eea; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-left: 8px; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-running { background: #d1ecf1; color: #0c5460; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-enriching { background: #fff3e0; color: #e65100; }
        .debug-panel { position: fixed; bottom: 20px; right: 20px; width: 450px; max-height: 300px; background: #1e1e1e; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 1000; }
        .debug-header { background: #333; color: #fff; padding: 12px 16px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .debug-content { height: 250px; overflow-y: auto; padding: 10px; font-family: 'Monaco', 'Menlo', monospace; font-size: 0.8rem; }
        .log-entry { padding: 4px 8px; border-radius: 4px; margin-bottom: 3px; }
        .log-time { color: #666; font-size: 0.75rem; }
        .log-info { color: #9cdcfe; }
        .log-success { color: #4ec9b0; }
        .log-warning { color: #dcdcaa; }
        .log-error { color: #f48771; }
        .log-debug { color: #808080; }
        .connection-status { position: fixed; top: 20px; right: 20px; padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; z-index: 1000; }
        .status-connected { background: #d4edda; color: #155724; }
        .status-disconnected { background: #f8d7da; color: #721c24; }
        .current-activity { background: #fff3cd; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-weight: 500; color: #856404; display: none; }
        .business-card { background: #f8f9fa; border-radius: 12px; padding: 16px; margin-bottom: 12px; border-left: 4px solid #667eea; }
        .business-name { font-weight: 600; font-size: 1.1rem; color: #333; }
        .business-details { font-size: 0.9rem; color: #666; margin-top: 8px; }
        .email-highlight { background: #d4edda; color: #155724; padding: 2px 8px; border-radius: 4px; }
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .logs-container { background: #1e1e1e; color: #d4d4d4; padding: 16px; border-radius: 8px; font-family: monospace; font-size: 0.85rem; max-height: 200px; overflow-y: auto; margin-top: 16px; display: none; }
        .logs-container.active { display: block; }
        .dedup-stats { margin-top: 12px; padding: 12px; background: #e3f2fd; border-radius: 8px; font-size: 0.9rem; }
        @media(max-width:1024px){ .main-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <header><h1>Google Maps Scraper</h1><p>Scrape business data with Smart Search</p></header>
        <div class="main-grid">
            <div class="left-panel">
                <div class="card">
                    <div class="card-header">Search Configuration</div>
                    <div class="card-body">
                        <form id="scrapeForm">
                            <div class="form-group">
                                <label for="query">Search Query</label>
                                <input type="text" id="query" placeholder="e.g., restaurants, plumbers" required>
                            </div>
                            <div class="form-group">
                                <label>Location</label>
                                <div class="tabs">
                                    <button type="button" class="tab active" onclick="switchTab('city')">Search Location</button>
                                    <button type="button" class="tab" onclick="switchTab('custom')">Custom Bounds</button>
                                </div>
                                <div id="city-tab" class="tab-content active">
                                    <div class="autocomplete-container">
                                        <input type="text" id="city-search" placeholder="Type a location..." autocomplete="off">
                                        <div id="city-dropdown" class="autocomplete-dropdown"></div>
                                    </div>
                                    <div id="selected-location" class="selected-location">
                                        <div class="location-title"></div>
                                        <div class="location-address"></div>
                                    </div>
                                    <div class="radius-control">
                                        <label>Search Radius: <span class="radius-value" id="radiusValue">10 km</span></label>
                                        <input type="range" id="radius" min="1" max="200" value="10">
                                    </div>
                                    <input type="hidden" id="city-place-id">
                                    <input type="hidden" id="city-bounds">
                                </div>
                                <div id="custom-tab" class="tab-content">
                                    <input type="text" id="custom_bounds" placeholder="min_lat,max_lat,min_lng,max_lng">
                                    <small style="color:#666;display:block;margin-top:4px">Format: -27.5,-26.9,152.9,153.5</small>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="target_count">Target Results</label>
                                <input type="number" id="target_count" value="100" min="1" max="10000">
                            </div>
                            <div class="form-group">
                                <label for="tile_size">Tile Size</label>
                                <select id="tile_size">
                                    <option value="0.005">Small (~550m) - Thorough</option>
                                    <option value="0.01" selected>Medium (~1.1km) - Balanced</option>
                                    <option value="0.02">Large (~2.2km) - Fast</option>
                                </select>
                            </div>
                            
                            <!-- Smart Mode Toggle -->
                            <div class="smart-mode">
                                <label>
                                    <input type="checkbox" id="smart_mode">
                                    <span style="font-weight:600;color:#667eea;">Smart Mode (100% Coverage)</span>
                                </label>
                                <div class="smart-description">
                                    Uses multiple search strategies: plural/singular variations, synonyms (business, company, services), 
                                    and deduplication to ensure no business is missed. May take longer but finds more results.
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-top:16px;">
                                <label><input type="checkbox" id="enrich_emails" checked> Enrich emails</label>
                            </div>
                            <div class="form-group">
                                <label><input type="checkbox" id="headless" checked> Headless mode</label>
                            </div>
                            <button type="submit" class="btn btn-primary" id="startBtn">Start Scraping</button>
                            <button type="button" class="btn btn-danger" id="stopBtn" style="display:none;margin-top:10px">Stop & Save Results</button>
                        </form>
                        <div class="progress-section" id="progressSection" style="display:none">
                            <div id="currentActivity" class="current-activity">Initializing...</div>
                            <h4>Progress <span id="statusBadge" class="status-badge status-pending">Pending</span></h4>
                            <div class="progress-bar-container">
                                <div class="progress-bar" id="progressBar" style="width:0%">0%</div>
                            </div>
                            <div class="stats-grid">
                                <div class="stat-box"><div class="stat-value" id="currentCount">0</div><div class="stat-label">Found</div></div>
                                <div class="stat-box"><div class="stat-value" id="targetCountDisplay">100</div><div class="stat-label">Target</div></div>
                                <div class="stat-box"><div class="stat-value" id="tilesCompleted">0</div><div class="stat-label">Tiles</div></div>
                                <div class="stat-box"><div class="stat-value" id="tilesTotal">0</div><div class="stat-label">Total</div></div>
                            </div>
                            <div id="dedupStats" class="dedup-stats" style="display:none"></div>
                        </div>
                        
                        <div id="emailEnrichmentSection" style="display:none;margin-top:16px;padding:16px;background:#fff3e0;border-radius:8px;border-left:4px solid #ff9800">
                            <h4 style="margin-bottom:12px;color:#e65100">Finding Emails...</h4>
                            <div class="progress-bar-container" style="margin-bottom:8px">
                                <div class="progress-bar" id="emailProgressBar" style="width:0%;background:#ff9800">0%</div>
                            </div>
                            <div style="display:flex;justify-content:space-between;font-size:0.9rem;color:#666">
                                <span id="emailProgressText">0 / 0 processed</span>
                                <span id="emailFoundCount">0 emails found</span>
                            </div>
                            <div id="currentEmailWebsite" style="margin-top:8px;font-size:0.85rem;color:#999;font-style:italic">Waiting...</div>
                        </div>
                        
                        <div id="saveDocumentSection" style="display:none;margin-top:16px;padding:16px;background:#e8f5e9;border-radius:8px;border-left:4px solid #34a853">
                            <button onclick="showSaveModal()" class="btn btn-primary" style="background:#34a853;width:100%">Save to Database</button>
                        </div>
                        
                        <div id="savedDocumentsSection" style="margin-top:20px;padding-top:20px;border-top:1px solid #e0e0e0">
                            <h4 style="margin-bottom:12px;display:flex;justify-content:space-between;align-items:center">
                                <span>Saved Documents</span>
                                <button onclick="loadSavedDocuments()" style="padding:6px 12px;background:#667eea;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.8rem">Refresh</button>
                            </h4>
                            <div id="savedDocumentsList" style="max-height:200px;overflow-y:auto">
                                <p style="color:#999;font-size:0.9rem">No saved documents yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="right-panel">
                <div class="card">
                    <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
                        <span>Live Results (<span id="resultCount">0</span>)</span>
                        <div id="exportButtons" style="display:none">
                            <button onclick="exportResults('json')" style="padding:6px 12px;margin-right:8px;background:#667eea;color:white;border:none;border-radius:4px;cursor:pointer">JSON</button>
                            <button onclick="exportResults('csv')" style="padding:6px 12px;background:#667eea;color:white;border:none;border-radius:4px;cursor:pointer">CSV</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="resultsContainer" class="results-section">
                            <div class="empty-state"><h3>No results yet</h3><p>Search for a location and start scraping</p></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="saveModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:2000;justify-content:center;align-items:center">
        <div style="background:white;border-radius:12px;padding:24px;width:90%;max-width:400px;box-shadow:0 20px 60px rgba(0,0,0,0.3)">
            <h3 style="margin-bottom:16px;color:#155724">Save Document</h3>
            <input type="text" id="documentName" placeholder="Enter document name..." style="width:100%;padding:12px;margin-bottom:16px;border:2px solid #e0e0e0;border-radius:8px;font-size:1rem">
            <div style="display:flex;gap:12px">
                <button onclick="saveDocument()" class="btn btn-primary" style="background:#34a853;flex:1">Save</button>
                <button onclick="hideSaveModal()" class="btn" style="background:#e0e0e0;color:#333;flex:1">Cancel</button>
            </div>
            <div id="saveStatus" style="margin-top:12px;font-size:0.9rem;text-align:center"></div>
        </div>
    </div>
    
    <div id="connectionStatus" class="connection-status status-disconnected">Disconnected</div>
    
    <div class="debug-panel" id="debugPanel">
        <div class="debug-header">
            <span>Live Debug Console</span>
            <button onclick="clearLogs()" style="background:#555;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:0.75rem">Clear</button>
        </div>
        <div class="debug-content" id="debugConsole"></div>
    </div>
    <script>
        let socket=null,currentJobId=null,businesses=[],predictions=[],selectedIndex=-1,debounceTimer=null,placeData=null;
        const locationIcon=`<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`;

        document.addEventListener('DOMContentLoaded',()=>{initializeSocket();initializeAutocomplete();document.getElementById('radius').addEventListener('input',e=>document.getElementById('radiusValue').textContent=e.target.value+' km')});

        function initializeAutocomplete(){const searchInput=document.getElementById('city-search'),dropdown=document.getElementById('city-dropdown');searchInput.addEventListener('input',e=>{clearTimeout(debounceTimer);const query=e.target.value.trim();if(query.length<2){dropdown.classList.remove('active');return}dropdown.innerHTML='<div class="autocomplete-item">Searching...</div>';dropdown.classList.add('active');debounceTimer=setTimeout(()=>fetchPredictions(query),200)});searchInput.addEventListener('keydown',handleKeyNavigation);document.addEventListener('click',e=>{if(!e.target.closest('.autocomplete-container'))dropdown.classList.remove('active')})}

        function fetchPredictions(query){fetch(`/api/places/autocomplete?q=${encodeURIComponent(query)}`).then(r=>r.json()).then(data=>{const dropdown=document.getElementById('city-dropdown');if(data.error||!data.predictions?.length){dropdown.innerHTML='<div class="autocomplete-item">No results</div>';return}predictions=data.predictions;selectedIndex=-1;dropdown.innerHTML=predictions.map((p,i)=>`<div class="autocomplete-item"data-index="${i}">${locationIcon}<div><div class="main-text">${p.main_text}</div><div class="secondary-text">${p.secondary_text}</div></div></div>`).join('');dropdown.querySelectorAll('.autocomplete-item').forEach(item=>item.addEventListener('click',()=>selectPlace(predictions[item.dataset.index])))}).catch(()=>document.getElementById('city-dropdown').innerHTML='<div class="autocomplete-item">Error</div>')}

        function handleKeyNavigation(e){const dropdown=document.getElementById('city-dropdown');if(!dropdown.classList.contains('active'))return;const items=dropdown.querySelectorAll('.autocomplete-item');switch(e.key){case'ArrowDown':e.preventDefault();selectedIndex=Math.min(selectedIndex+1,items.length-1);updateSelection(items);break;case'ArrowUp':e.preventDefault();selectedIndex=Math.max(selectedIndex-1,-1);updateSelection(items);break;case'Enter':e.preventDefault();if(selectedIndex>=0&&predictions[selectedIndex])selectPlace(predictions[selectedIndex]);break;case'Escape':dropdown.classList.remove('active')}}

        function updateSelection(items){items.forEach((item,i)=>item.classList.toggle('selected',i===selectedIndex));if(selectedIndex>=0&&items[selectedIndex])items[selectedIndex].scrollIntoView({block:'nearest'})}

        function selectPlace(place){document.getElementById('city-search').value=place.description;document.getElementById('city-place-id').value=place.place_id;document.getElementById('city-dropdown').classList.remove('active');fetch(`/api/places/details/${place.place_id}`).then(r=>r.json()).then(data=>{if(data.error)return;placeData=data;updateBoundsFromRadius();document.querySelector('#selected-location .location-title').textContent=data.name;document.querySelector('#selected-location .location-address').textContent=data.address;document.getElementById('selected-location').classList.add('active')}).catch(console.error)}

        function updateBoundsFromRadius(){if(!placeData)return;const radiusKm=parseInt(document.getElementById('radius').value),lat=placeData.latitude,lng=placeData.longitude,latDelta=radiusKm/111,lngDelta=radiusKm/(111*Math.cos(lat*Math.PI/180));document.getElementById('city-bounds').value=`${lat-latDelta},${lat+latDelta},${lng-lngDelta},${lng+lngDelta}`}

        function initializeSocket(){
            console.log('Initializing SocketIO...');
            addLog('Connecting to server...','info');
            socket=io({transports:['websocket','polling'],reconnection:true});
            
            socket.on('connect',()=>{
                console.log('Socket connected:',socket.id);
                document.getElementById('connectionStatus').textContent='Connected';
                document.getElementById('connectionStatus').className='connection-status status-connected';
                addLog('Connected to server','success');
            });
            
            socket.on('disconnect',()=>{
                console.log('Socket disconnected');
                document.getElementById('connectionStatus').textContent='Disconnected';
                document.getElementById('connectionStatus').className='connection-status status-disconnected';
                addLog('Disconnected from server','warning');
            });
            
            socket.on('connect_error',(err)=>{
                console.error('Socket error:',err);
                addLog('Connection error: '+err.message,'error');
            });
            
            socket.on('job_created',data=>{
                currentJobId=data.id;
                console.log('Job created:',data.id);
                updateStatus('pending');
                addLog('Job created: '+data.id,'info');
            });
            
            socket.on('job_started',data=>{
                console.log('Job started:',data);
                updateStatus('running');
                document.getElementById('tilesTotal').textContent=data.tiles_total;
                addLog('Job started with '+data.tiles_total+' tiles','success');
                showActivity('Scraping in progress...');
            });
            
            socket.on('progress_update',data=>updateProgress(data));
            
            socket.on('business_found',data=>{
                addBusiness(data.business);
                updateProgress(data);
            });
            
            socket.on('job_completed',data=>{
                console.log('Job completed:',data);
                updateStatus('completed');
                updateProgress(data);
                toggleButtons(false);
                document.getElementById('exportButtons').style.display='block';
                document.getElementById('saveDocumentSection').style.display='block';
                showDedupStats(data.deduplication_stats);
                addLog(data.message||'Job completed!','success');
                showActivity('Completed!');
            });
            
            socket.on('job_stopped',data=>{
                updateStatus('stopped');
                toggleButtons(false);
                document.getElementById('exportButtons').style.display='block';
                addLog('Stopped. Saved '+data.results_count+' results','warning');
                showActivity('Stopped by user');
            });
            
            socket.on('job_paused',data=>{
                updateStatus('paused');
                toggleButtons(false);
            });
            
            socket.on('job_error',data=>{
                console.error('Job error:',data);
                updateStatus('error');
                toggleButtons(false);
                addLog('ERROR: '+data.error,'error');
                showActivity('Error occurred!');
                alert('Error: '+data.error);
            });
            
            socket.on('log_message',data=>{
                addLog(data.message,data.level);
                if(data.level==='info'||data.level==='success'){
                    showActivity(data.message);
                }
            });
            
            socket.on('document_saved',data=>{
                if(data.success){
                    document.getElementById('saveStatus').innerHTML='<span style="color:green">✓ '+data.message+'</span>';
                    setTimeout(()=>{hideSaveModal();loadSavedDocuments();},1500);
                }else{
                    document.getElementById('saveStatus').innerHTML='<span style="color:red">✗ '+data.error+'</span>';
                }
            });
            
            socket.on('email_enrichment_started',data=>{
                document.getElementById('emailEnrichmentSection').style.display='block';
                document.getElementById('emailProgressText').textContent='0 / '+data.total+' processed';
                document.getElementById('emailFoundCount').textContent='0 emails found';
                updateStatus('enriching');
            });
            
            socket.on('email_enrichment_progress',data=>{
                const pct=Math.round((data.current/data.total)*100);
                document.getElementById('emailProgressBar').style.width=pct+'%';
                document.getElementById('emailProgressBar').textContent=pct+'%';
                document.getElementById('emailProgressText').textContent=data.current+' / '+data.total+' processed';
                document.getElementById('emailFoundCount').textContent=data.enriched+' emails found';
            });
            
            socket.on('business_updated',data=>{
                // Update the business row in the table with new email
                const rows=document.querySelectorAll('#resultsTableBody tr');
                rows.forEach(row=>{
                    if(row.cells[1]&&row.cells[1].textContent===data.place_id){
                        row.cells[4].innerHTML=data.email?'<span style="color:green;font-weight:600">'+escapeHtml(data.email)+'</span>':'';
                    }
                });
            });
            
            socket.on('email_enrichment_completed',data=>{
                document.getElementById('emailProgressBar').style.width='100%';
                document.getElementById('emailProgressBar').textContent='100%';
                document.getElementById('currentEmailWebsite').textContent='Complete! Found '+data.enriched+' emails';
                updateStatus('completed');
            });
            
            // Load saved documents on startup
            loadSavedDocuments();
        }

        function addLog(message,level='info'){
            const console=document.getElementById('debugConsole');
            const entry=document.createElement('div');
            entry.className='log-entry log-'+level;
            const time=new Date().toLocaleTimeString('en-US',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
            entry.innerHTML='<span class="log-time">['+time+']</span> <span class="log-'+level+'">'+escapeHtml(message)+'</span>';
            console.appendChild(entry);
            console.scrollTop=console.scrollHeight;
        }

        function escapeHtml(text){
            const div=document.createElement('div');
            div.textContent=text;
            return div.innerHTML;
        }

        function clearLogs(){
            document.getElementById('debugConsole').innerHTML='';
        }

        function showActivity(text){
            const el=document.getElementById('currentActivity');
            el.textContent=text;
            el.style.display='block';
        }

        function showDedupStats(stats){if(!stats)return;const el=document.getElementById('dedupStats');el.style.display='block';el.innerHTML='<strong>Deduplication:</strong> '+stats.unique_businesses+' unique businesses found using '+stats.search_variations_used+' search variations'}

        function toggleButtons(running){document.getElementById('startBtn').style.display=running?'none':'block';document.getElementById('stopBtn').style.display=running?'block':'none';if(running)document.getElementById('progressSection').style.display='block';}

        function switchTab(tab){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));event.target.classList.add('active');document.getElementById(tab+'-tab').classList.add('active')}

        document.getElementById('scrapeForm').addEventListener('submit',e=>{e.preventDefault();startScraping()});document.getElementById('stopBtn').addEventListener('click',()=>{if(currentJobId){socket.emit('stop_scrape',{job_id:currentJobId});addLog('Stop requested...','warning');}});

        function startScraping(){if(placeData)updateBoundsFromRadius();const bounds=document.getElementById('city-bounds').value,customBounds=document.getElementById('custom_bounds').value;if(!bounds&&!customBounds){alert('Select a location');return}businesses=[];document.getElementById('resultsContainer').innerHTML='';document.getElementById('dedupStats').style.display='none';document.getElementById('emailEnrichmentSection').style.display='none';document.getElementById('saveDocumentSection').style.display='none';document.getElementById('documentName').value='';document.getElementById('saveStatus').innerHTML='';toggleButtons(true);const data={query:document.getElementById('query').value,custom_bounds:bounds||customBounds,target_count:parseInt(document.getElementById('target_count').value),tile_size:parseFloat(document.getElementById('tile_size').value),enrich_emails:document.getElementById('enrich_emails').checked,headless:document.getElementById('headless').checked,smart_mode:document.getElementById('smart_mode').checked};document.getElementById('targetCountDisplay').textContent=data.target_count;addLog('Starting scrape...','info');addLog('Query: '+data.query,'debug');if(data.smart_mode)addLog('Smart Mode enabled','info');socket.emit('start_scrape',data)}

        function updateProgress(data){const pct=Math.min(data.progress_percent||0,100);document.getElementById('progressBar').style.width=pct+'%';document.getElementById('progressBar').textContent=pct+'%';document.getElementById('currentCount').textContent=data.current_count||0;document.getElementById('tilesCompleted').textContent=data.tiles_completed||0;document.getElementById('resultCount').textContent=data.current_count||0;}

        function updateStatus(status){const badge=document.getElementById('statusBadge');badge.className='status-badge status-'+status;badge.textContent=status;}

        function addBusiness(b){businesses.push(b);const container=document.getElementById('resultsContainer');if(businesses.length===1){container.innerHTML='<table id="resultsTable" style="width:100%;border-collapse:collapse;font-size:14px"><thead style="background:#f3f4f6;position:sticky;top:0"><tr><th style="padding:10px;text-align:left;border-bottom:2px solid #ddd">Name</th><th style="padding:10px;text-align:left;border-bottom:2px solid #ddd">Address</th><th style="padding:10px;text-align:left;border-bottom:2px solid #ddd">Phone</th><th style="padding:10px;text-align:left;border-bottom:2px solid #ddd">Website</th><th style="padding:10px;text-align:left;border-bottom:2px solid #ddd">Email</th><th style="padding:10px;text-align:left;border-bottom:2px solid #ddd">Rating</th></tr></thead><tbody id="resultsTableBody"></tbody></table>'}const row=document.createElement('tr');row.style.borderBottom='1px solid #eee';row.innerHTML='<td style="padding:8px">'+escapeHtml(b.name)+'</td><td style="padding:8px">'+escapeHtml(b.address||'')+'</td><td style="padding:8px">'+escapeHtml(b.phone||'')+'</td><td style="padding:8px">'+(b.website?'<a href="'+b.website+'" target="_blank">'+escapeHtml(b.website.substring(0,30))+'</a>':'')+'</td><td style="padding:8px">'+(b.email?'<span style="color:green;font-weight:600">'+escapeHtml(b.email)+'</span>':'')+'</td><td style="padding:8px">'+(b.rating?b.rating+' ⭐':'')+'</td>';document.getElementById('resultsTableBody').appendChild(row);}

        function exportResults(fmt){if(!currentJobId)return;addLog('Exporting as '+fmt.toUpperCase()+'...','info');fetch('/api/jobs/'+currentJobId+'/export/'+fmt).then(r=>{if(r.ok&&fmt==='csv'){return r.blob().then(blob=>{const url=window.URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=currentJobId+'_results.csv';document.body.appendChild(a);a.click();document.body.removeChild(a);addLog('CSV downloaded!','success');})}else if(r.ok){return r.json().then(d=>{addLog('Export complete!','success');alert(d.message);})}else{return r.json().then(d=>{addLog('Export failed: '+d.error,'error');})}}).catch(e=>addLog('Export error: '+e,'error'));}

        function saveDocument(){
            if(!currentJobId)return;
            const name=document.getElementById('documentName').value.trim();
            if(!name){document.getElementById('saveStatus').innerHTML='<span style="color:red">Please enter a document name</span>';return}
            document.getElementById('saveStatus').innerHTML='<span style="color:#666">Saving...</span>';
            socket.emit('save_document',{job_id:currentJobId,document_name:name,city:placeData?.name||''});
        }

        function showSaveModal(){
            document.getElementById('saveModal').style.display='flex';
            document.getElementById('documentName').value='';
            document.getElementById('saveStatus').innerHTML='';
            document.getElementById('documentName').focus();
        }

        function hideSaveModal(){
            document.getElementById('saveModal').style.display='none';
        }

        function loadSavedDocuments(){
            fetch('/api/documents').then(r=>r.json()).then(data=>{
                const list=document.getElementById('savedDocumentsList');
                if(data.error||!data.documents||data.documents.length===0){list.innerHTML='<p style="color:#999;font-size:0.9rem">No saved documents yet</p>';return}
                list.innerHTML=data.documents.map(d=>'<div style="padding:10px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center"><div><strong>'+escapeHtml(d.document_name)+'</strong><br><span style="font-size:0.8rem;color:#666">'+d.total_results+' results • '+new Date(d.created_at).toLocaleDateString()+'</span></div><div><button onclick="downloadSavedDocument(\''+d.id+'\')" style="padding:4px 8px;background:#667eea;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.8rem;margin-right:4px">Download</button><button onclick="deleteSavedDocument(\''+d.id+'\')" style="padding:4px 8px;background:#f5576c;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.8rem">Delete</button></div></div>').join('');
            }).catch(()=>{document.getElementById('savedDocumentsList').innerHTML='<p style="color:#999;font-size:0.9rem">Failed to load documents</p>';});
        }

        function downloadSavedDocument(docId){
            fetch('/api/documents/'+docId+'/download').then(r=>{if(r.ok){return r.blob().then(blob=>{const url=window.URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='document_'+docId+'.csv';document.body.appendChild(a);a.click();document.body.removeChild(a);addLog('Document downloaded!','success');})}else{addLog('Download failed','error')}}).catch(e=>addLog('Download error: '+e,'error'));
        }

        function deleteSavedDocument(docId){
            if(!confirm('Delete this document?'))return;
            fetch('/api/documents/'+docId,{method:'DELETE'}).then(r=>r.json()).then(data=>{if(data.success){loadSavedDocuments();addLog('Document deleted','success')}else{addLog('Delete failed','error')}}).catch(e=>addLog('Delete error: '+e,'error'));
        }
    </script>
</body>
</html>
